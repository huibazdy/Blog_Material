# 预处理器

## 一、背景

编译一个C程序涉及多个步骤，第一个步骤被称为**预处理（preprocessing）**。C语言**预处理器（preprocessor）**在源代码进入编译前对其进行一些文本性质的操作。这些操作主要包括：

* 插入被***#include***指令包含的文件的内容
* 定义和替换***#define***指令定义的符号
* 确定代码的部分内容是否需要根据***条件编译***指令进行编译
* 删除注释

> 预处理器在程序执行前查看程序，所以称之为预处理器

## 二、预定义符号

C语言预定义符号是由C预处理器定义的**宏定义**符号，共五个。它们的值为字符串常量或者十进制数字常量。

| 符号         | 含义                                  | 样例值        |
| ------------ | ------------------------------------- | ------------- |
| **`_FILE_`** | 进行编译的源文件                      | "name.c"      |
| **`_LINE_`** | 文件当前行号                          | 25            |
| **`_DTAE_`** | 文件被编译的日期                      | "Jul 10 2022" |
| **`_TIME_`** | 文件被编译的时间                      | "14:22:30"    |
| **`_STDC_`** | 若编译器遵循ANSI C，值为1，否则未定义 | 1             |



## 三、#define

> #define语句分为三部分：
>
> 1. #define指令本身
> 2. 宏
>     * 本质上是一个字符串常量
>     * 有些宏代表值，称为类对象宏（object-like macro）
>     * 有些宏代表函数，称为类函数宏（function-like macro）
>     * 宏名称不允许有空格，只能包含字符、数字、下划线，且首字符不能是数字
>     * 预处理器找到宏实例后就会用替换体替代该宏（也有例外）
>     * 从宏最终变为替换文本的过程称为宏展开（macro expansion）
>     * 宏可以自身使用圆括号带一个或多个参数，随后这些参数出现在替换体中
> 3. 替换体
>     * 字符串
>     * 表达式
>     * 函数体

### 3.1 宏替换

类对象宏：

`#define MAX 100`

类函数宏：

`#define HELLO printf("hello world!")`

带参数的类函数宏：

`#define MEAN(X,Y) (((X) + (Y)) / 2)`

`#define SQAURE(X) X*X`

### 3.2 宏和函数的选择

这个问题实际上是时间和空间的权衡。

宏生成***内联代码***，即在程序中生成语句。如果调用10次，即在程序中插入10行代码（假定宏只定义为一行），而使用函数只需要一份函数语句的副本，节省了空间。

而另一方面，程序控制需要跳转到函数内，随后返回到主调程序，显然比内联代码更花时间。

> C99之后提供了***内联函数***。

总结下来，可以归为：

* 简单函数，使用宏，例如：
    * `#define MAX(X,Y) ((X) > (Y) ? (X) : (Y))`
    * `#define ABS(X) ((X) < 0 ? -(X) : (X))`



